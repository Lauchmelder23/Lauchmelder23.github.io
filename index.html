<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanji</title>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <style>
        .part {
            transition: stroke-width 100ms;
        }

        .one {
            stroke: rgb(255, 88, 88);
        }

        .two {
            stroke: rgb(53, 206, 53)
        }

        .three {
            stroke: rgb(47, 172, 255)
        }

        .four {
            stroke:rgb(252, 193, 0)
        }

        .on {
            stroke-width: 4;
            cursor: pointer;
        }

        span {
            display: inline-block;
            width: 50vh;
            height: 50vh;
            background-size: cover;
            border-style: solid;
            margin-top: 10px;
        }

        input {
            font-size: 1em;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        h1, h2 {
            font-family: Helvetica, Arial, sans-serif;
        }

    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<body>
    <h1>Enter a Kanji</h1>
    <form>
        <table>
            <tr>
            <td><input type="text" name="kanji"></td>
            <td><input type="submit"></td>
            </tr>
        </table>
    </form>
    <span id="kanji_container">Loading</span>

    <h2 id="kanji_meaning">Meanings currently not available due to CORS issues</h2>

    <script>
        // Helper function to get GET parameter from URL
        $.urlParam = function(name){
            var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
            try {
                return results[1] || 0;
            } catch (error) {
                return undefined;
            }
	        
        }

        // Helper function to load the KanjiVG from its unicode
        $.loadSVG = function(hex) {
            return $.ajax({
                url: "assets/0" + hex + ".svg",
                dataType: "text",
                success: function(data) {
                    $("#kanji_container").html(data);   // Put svg in DOM
                    $("svg > g:nth-child(2)").remove(); // Remove stroke numbering
                    $("span").contents().filter((_, el) => el.nodeType === 3).remove(); // Remove weird text
                }
            });
        }

        // Helper function to extract only top-level elements of Kanji
        $.getHighestElements = function(startPoint, selector, child = false) {
            var elems = []; 
            startPoint.children('g').each(function () { // For each element in SVG
                if(typeof $(this).attr(selector) !== typeof undefined) {    // If it has the desired attribute
                    elems.push($(this));    // Add it to list
                } else {
                    $.merge(elems, $.getHighestElements($(this), selector, true));  // Recurse
                }
            });
            
            if(child)   // If this function was called by recursion
                return elems;   // Return the raw array
            else
                return $(elems).map(function() { return this.toArray(); }); // Prepare array for jQuery usage
        }

        // Get Kanji from GET request
        const kanji_raw = $.urlParam('kanji');
        if(kanji_raw != undefined)
        {
            // Get character representation from URL representation
            const kanji = decodeURIComponent(kanji_raw);

            // Set value of input field to Kanji
            $("form input[name=kanji]").val(kanji);

            // Get Hex code of Kanji
            var hex = kanji.charCodeAt(0).toString(16);
            $.loadSVG(hex).then( response => {  // Load the SVG of the Kanji
                var allParts = $.getHighestElements($("svg > g > g"), "kvg:element");   // Get top-level elements

                allParts.addClass("part");  // Give them class "part" as well (for default styling)

                const number_words = ["one", "two", "three", "four"]
                var i = 0;
                allParts.each(function () {
                    try {
                        $(this).addClass(number_words[i++]);
                    } catch (error) {
                        // Do nothing, this shouldn't ever be hit but just in case
                    }
                });

                allParts.on({   // For each element
                    mouseenter: function () {   // MouseEnter event: give on class
                        $(this).addClass("on");
                    },
                    mouseleave: function () {   // MouseLeave event: remove on class
                        $(this).removeClass("on");
                    },
                });

                // If element is clicked, redirect website to this element
                allParts.click(function() {
                    window.location = window.location.origin + "?kanji=" + $(this).attr("kvg:element");
                });
            });

            $.ajax({
                url: "https://kanjiapi.dev/v1/kanji/" + kanji_raw,
                dataType: "jsonp",
                success: function(res) {
                    console.log(res);
                }
            });            
        }

    </script>
</body>
</html>
